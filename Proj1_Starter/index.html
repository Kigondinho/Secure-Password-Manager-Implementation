<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Secure Keychain Manager</title>
    <link rel="stylesheet" href="styles.css"> </head>
<body>
    <h1>Secure Keychain Manager</h1>
    
    <div id="locked-view" class="view">
        <h2>ðŸ”’ Unlock or Create Keychain</h2>
        <input type="password" id="master-password" placeholder="Enter Master Password">
        <button onclick="handleInit()">Create New</button>
        <button onclick="handleLoad()">Load Existing</button>
        <div id="auth-message" class="error"></div>
    </div>

    <div id="unlocked-view" class="view"> 
        <h2>ðŸ”‘ Management Console</h2>
        
        <h3>Add/Update Entry</h3>
        <input type="text" id="domain-name" placeholder="Domain Name (e.g., google.com)">
        <input type="password" id="entry-password" placeholder="Password to store">
        <button onclick="handleSet()">Save/Update</button>
        <button onclick="handleGet()">Get Password</button>
        <button onclick="handleRemove()">Remove</button>
        <div id="op-message" class="error"></div>

        <hr>
        <h3>Keychain Status</h3>
        <button onclick="handleDump()">Save to Local Storage (Simulate Disk)</button>
        <p>Stored Entries (<span id="entry-count">0</span>):</p>
        <pre id="kvs-display"></pre>
        <p>Trusted Checksum: <span id="checksum-display"></span></p>
    </div>

    <script src="lib.js"></script>
    <script src="password-manager.js"></script>
    <script>
        // Placeholder for the main keychain instance
        let currentKeychain = null;
        
        // --- LOCAL STORAGE UTILITIES ---
        const STORAGE_KEY = "secure_keychain_data";
        const CHECKSUM_KEY = "trusted_data_checksum";

        function saveToStorage(repr, checksum) {
            localStorage.setItem(STORAGE_KEY, repr);
            localStorage.setItem(CHECKSUM_KEY, checksum);
            document.getElementById('checksum-display').textContent = checksum;
        }

        // --- UI UPDATE FUNCTIONS ---
        function updateUI(keychain) {
            document.getElementById('locked-view').style.display = 'none';
            document.getElementById('unlocked-view').style.display = 'block';
            
            // Display the current (encrypted) state from the KVS
            const kvs = keychain.data.kvs;
            document.getElementById('entry-count').textContent = Object.keys(kvs).length;
            document.getElementById('kvs-display').textContent = JSON.stringify(kvs, null, 2);
            document.getElementById('checksum-display').textContent = localStorage.getItem(CHECKSUM_KEY) || 'N/A (unsaved)';
        }

        function displayMessage(id, message, isError = true) {
            const element = document.getElementById(id);
            element.textContent = message;
            element.className = isError ? 'error' : 'success';
        }

        // --- ASYNC HANDLERS (using your Keychain API) ---

        async function handleInit() {
            const password = document.getElementById('master-password').value;
            if (password.length < 8) { // Basic sanity check
                return displayMessage('auth-message', 'Master password must be strong (e.g., 8+ chars).');
            }

            try {
                // 1. Initialize the keychain
                const keychain = await Keychain.init(password);
                currentKeychain = keychain;
                
                // 2. Dump and save the initial, empty state to "disk" (Local Storage)
                const [repr, checksum] = await keychain.dump();
                saveToStorage(repr, checksum);

                displayMessage('auth-message', 'Keychain created and secured!', false);
                updateUI(keychain);
            } catch (e) {
                displayMessage('auth-message', 'Initialization Error: ' + e.message);
            }
        }

        async function handleLoad() {
            const password = document.getElementById('master-password').value;
            const repr = localStorage.getItem(STORAGE_KEY);
            const trustedDataCheck = localStorage.getItem(CHECKSUM_KEY);

            if (!repr) {
                return displayMessage('auth-message', 'No keychain found in storage. Please create a new one.');
            }

            try {
                // Load the keychain, performing password authentication and rollback check
                const keychain = await Keychain.load(password, repr, trustedDataCheck);
                currentKeychain = keychain;
                
                displayMessage('auth-message', 'Keychain successfully loaded and verified!', false);
                updateUI(keychain);
            } catch (e) {
                // This will catch password errors OR integrity check failures
                displayMessage('auth-message', 'Load Failed: ' + e.message);
            }
        }

        async function handleSet() {
            const domain = document.getElementById('domain-name').value;
            const value = document.getElementById('entry-password').value;
            
            if (!currentKeychain) return displayMessage('op-message', 'Keychain not loaded.');
            if (!domain || !value) return displayMessage('op-message', 'Domain and Password are required.');

            try {
                await currentKeychain.set(domain, value);
                displayMessage('op-message', `Entry for ${domain} saved/updated successfully!`, false);
                updateUI(currentKeychain);
            } catch (e) {
                displayMessage('op-message', 'Set Error: ' + e.message);
            }
        }

        async function handleGet() {
            const domain = document.getElementById('domain-name').value;
            
            if (!currentKeychain) return displayMessage('op-message', 'Keychain not loaded.');
            if (!domain) return displayMessage('op-message', 'Domain is required for retrieval.');

            try {
                const password = await currentKeychain.get(domain);
                if (password) {
                    displayMessage('op-message', `Password for ${domain}: ${password}`, false);
                } else {
                    displayMessage('op-message', `Entry for ${domain} not found.`);
                }
            } catch (e) {
                // This is the critical security check failure (Swap Attack/Tampering)
                displayMessage('op-message', 'Retrieval Failed: ' + e.message);
            }
        }

        async function handleRemove() {
            const domain = document.getElementById('domain-name').value;
            
            if (!currentKeychain) return displayMessage('op-message', 'Keychain not loaded.');
            if (!domain) return displayMessage('op-message', 'Domain is required to remove.');

            try {
                const removed = await currentKeychain.remove(domain);
                if (removed) {
                    displayMessage('op-message', `Entry for ${domain} successfully removed.`, false);
                    updateUI(currentKeychain);
                } else {
                    displayMessage('op-message', `Entry for ${domain} not found.`);
                }
            } catch (e) {
                displayMessage('op-message', 'Remove Error: ' + e.message);
            }
        }

        async function handleDump() {
            if (!currentKeychain) return displayMessage('op-message', 'Keychain not loaded.');

            try {
                const [repr, checksum] = await currentKeychain.dump();
                saveToStorage(repr, checksum);
                displayMessage('op-message', 'Keychain safely dumped and checksum stored!', false);
            } catch (e) {
                displayMessage('op-message', 'Dump Error: ' + e.message);
            }
        }
    </script>
</body>
</html>